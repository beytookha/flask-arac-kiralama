{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4 py-5 mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4 p-4 bg-dark text-white shadow rounded-4 border-start border-5 border-warning">
        <div>
            <h2 class="mb-0 fw-bold text-uppercase">
                <i class="fas fa-database me-2 text-warning"></i>Veritabanı Yönetim Merkezi
            </h2>
            <span class="text-white-50 small">Tüm tablolar, ham veriler ve SQL konsolu.</span>
        </div>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-light fw-bold">Panele Dön</a>
    </div>

    <ul class="nav nav-tabs mb-4 border-bottom-0" id="dbTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold bg-white text-dark border-0 shadow-sm me-2 rounded-top"
                    id="explorer-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#explorer"
                    type="button"
                    role="tab"
                    aria-controls="explorer"
                    aria-selected="true">
                <i class="fas fa-table me-2 text-primary"></i>Tablo Gezgini
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold bg-white text-dark border-0 shadow-sm me-2 rounded-top"
                    id="sql-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#sql"
                    type="button"
                    role="tab"
                    aria-controls="sql"
                    aria-selected="false">
                <i class="fas fa-terminal me-2 text-danger"></i>SQL Konsolu
            </button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold bg-white text-dark border-0 shadow-sm rounded-top"
                    id="schema-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#schema"
                    type="button"
                    role="tab"
                    aria-controls="schema"
                    aria-selected="false">
                <i class="fas fa-project-diagram me-2 text-success"></i>İlişki Şeması (ERD)
            </button>
        </li>
    </ul>

    <div class="tab-content">

        <!-- TABLO GEZGİNİ -->
        <div class="tab-pane fade show active" id="explorer" role="tabpanel" aria-labelledby="explorer-tab">
            <div class="row">
                <div class="col-md-3">
                    <div class="card shadow border-0">
                        <div class="card-header bg-dark text-white fw-bold">Tablolar</div>
                        <div class="list-group list-group-flush">
                            {% for t in tables %}
                                <a href="?tablo={{ t }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {{ 'bg-warning text-dark fw-bold' if secilen_tablo == t else '' }}">
                                    <span><i class="fas fa-table text-secondary me-2"></i>{{ t }}</span>
                                    <i class="fas fa-chevron-right small"></i>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-9">
                    <div class="card shadow border-0">
                        <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-list me-2"></i>{{ secilen_tablo or 'Tablo Seçiniz' }} Verileri</span>
                            {% if rows %}
                                <span class="badge bg-secondary">{{ rows|length }} Kayıt</span>
                            {% endif %}
                        </div>

                        <div class="card-body p-0 table-responsive" style="max-height: 600px;">
                            {% if secilen_tablo and columns %}
                                <table class="table table-striped table-hover mb-0 font-monospace small">
                                    <thead class="bg-dark text-white sticky-top">
                                        <tr>
                                            {% for col in columns %}
                                                <th>{{ col }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in rows %}
                                            <tr>
                                                {% for cell in row %}
                                                    <td>{{ cell }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="text-center py-5 text-muted">
                                    <i class="fas fa-arrow-left fa-3x mb-3"></i>
                                    <p>Verilerini görmek için soldan bir tablo seçin.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQL KONSOLU -->
        <div class="tab-pane fade" id="sql" role="tabpanel" aria-labelledby="sql-tab">
            <div class="card shadow border-0">
                <div class="card-body bg-dark rounded text-white">
                    <label class="fw-bold text-warning mb-2">SQL Sorgusu Yazın:</label>
                    <textarea id="sqlInput"
                              class="form-control bg-black text-success font-monospace border-secondary"
                              rows="5"
                              placeholder="SELECT * FROM Musteri;"></textarea>
                    <div class="text-end mt-3">
                        <button type="button" onclick="runSQL()" class="btn btn-warning fw-bold px-4">
                            <i class="fas fa-play me-2"></i>Çalıştır
                        </button>
                    </div>
                </div>
            </div>

            <div id="sqlResult" class="mt-4"></div>
        </div>

        <!-- ERD -->
        <div class="tab-pane fade" id="schema" role="tabpanel" aria-labelledby="schema-tab">
            <div class="card shadow border-0">
                <div class="card-body text-center overflow-auto" style="background-color: #f8f9fa;">
                    <h5 class="fw-bold mb-4">Veritabanı İlişki Haritası</h5>

                    {% raw %}
<div class="mermaid">
erDiagram
  SEHIR ||--o{ ARAC : bulundurur
  KATEGORI ||--o{ ARAC : siniflandirir
  SIGORTA ||--o{ ARAC : kapsar
  ARAC ||--o{ REZERVASYON : kiralanir
  MUSTERI ||--o{ REZERVASYON : olusturur
  REZERVASYON ||--|| ODEME : gerektirir
  MUSTERI ||--o{ YORUM : yazar
  MUSTERI ||--o{ FAVORI : ekler
  ARAC ||--o{ FAVORI : listelenir
  ARAC ||--o{ BAKIM : gider
  REZERVASYON ||--o{ REZERVASYON_EKSTRA : icerir
  EKSTRA_HIZMET ||--o{ REZERVASYON_EKSTRA : secilir

  ARAC {
    int arac_id PK
    string marka
    string model
    float ucret
  }

  MUSTERI {
    int musteri_id PK
    string ad
    string soyad
    string eposta
  }

  REZERVASYON {
    int rezervasyon_id PK
    date baslangic
    date bitis
    float toplam
  }
</div>
                    {% endraw %}

                    <div class="text-muted small mt-3">
                        Not: ERD, bu sekmede ilk açılışta otomatik render edilir.
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Mermaid: Tab açılınca render et (Bootstrap tabs ile en stabil yöntem) -->
<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";

  mermaid.initialize({ startOnLoad: false, theme: "default" });

  let rendered = false;

  async function renderMermaidIfNeeded() {
    if (rendered) return;
    const nodes = document.querySelectorAll(".mermaid");
    if (!nodes.length) return;
    await mermaid.run({ nodes });
    rendered = true;
  }

  const schemaTabBtn = document.getElementById("schema-tab");
  schemaTabBtn?.addEventListener("shown.bs.tab", () => {
    renderMermaidIfNeeded();
  });

  // Eğer sayfa ERD sekmesi açık gelirse
  if (document.getElementById("schema")?.classList.contains("show")) {
    renderMermaidIfNeeded();
  }
</script>

<script>
  function runSQL() {
    const query = document.getElementById('sqlInput').value;
    const resultDiv = document.getElementById('sqlResult');

    resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-warning"></div></div>';

    fetch('/admin/run-sql', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: 'query=' + encodeURIComponent(query)
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'error') {
        resultDiv.innerHTML = `<div class="alert alert-danger font-monospace">${data.message}</div>`;
      } else if (data.message) {
        resultDiv.innerHTML = `<div class="alert alert-success font-monospace">${data.message}</div>`;
      } else {
        let html = '<div class="card shadow border-0"><div class="card-body p-0 table-responsive"><table class="table table-dark table-striped mb-0 font-monospace small"><thead><tr>';
        data.columns.forEach(col => html += `<th>${col}</th>`);
        html += '</tr></thead><tbody>';

        data.rows.forEach(row => {
          html += '<tr>';
          row.forEach(cell => html += `<td>${cell}</td>`);
          html += '</tr>';
        });

        html += '</tbody></table></div></div>';
        resultDiv.innerHTML = html;
      }
    })
    .catch(() => {
      resultDiv.innerHTML = `<div class="alert alert-danger font-monospace">Sunucuya ulaşılamadı.</div>`;
    });
  }
</script>
{% endblock %}
