{% extends "layout.html" %}

{% block title %}Araç Kiralama - Ana Sayfa{% endblock %}

{% block body %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    /* --- HERO ALANI --- */
    .hero-wrapper {
        position: relative; height: 600px; width: 100%; overflow: hidden;
        border-radius: 0 0 50px 50px; margin-bottom: 50px; margin-top: -30px;
    }
    .hero-bg {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: url('https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?q=80&w=2048&auto=format&fit=crop');
        background-size: cover; background-position: center; z-index: 1;
        animation: slowZoom 20s infinite alternate;
    }
    @keyframes slowZoom { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
    .hero-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8)); z-index: 2; }
    .hero-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3; width: 85%; text-align: center; }
    .hero-title { font-size: 3.5rem; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 10px; }
    .hero-title span { color: #ffc107; }
    .hero-subtitle { font-size: 1.2rem; color: #ddd; margin-bottom: 40px; font-weight: 400; }

    /* Arama Kutusu */
    .search-glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
    .form-control-glass { background: rgba(255, 255, 255, 0.95); border: none; height: 55px; font-weight: 700; color: #2c3e50; padding-left: 20px; padding-right: 20px; border-radius: 12px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; }
    .form-control-glass:focus { background: #ffffff; box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3); outline: none; }
    .form-label-glass { color: #ffc107; font-weight: 800; text-transform: uppercase; font-size: 0.85rem; margin-bottom: 8px; display: block; text-align: left; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    /* Harita & Efektler */
    #map { height: 350px; width: 100%; border-radius: 15px; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .hover-card { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .hover-card:hover { transform: translateY(-10px); box-shadow: 0 15px 30px rgba(0,0,0,0.15) !important; z-index: 10; border-color: #ffc107 !important; }
    .btn-heart { transition: all 0.3s ease; }
    .btn-heart:active { transform: scale(0.8); }
</style>

<div class="hero-wrapper shadow-lg">
    <div class="hero-bg"></div>
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <h1 class="hero-title">Yola Hükmet. <span>Tarzını Yansıt.</span></h1>
        <p class="hero-subtitle">Türkiye'nin 81 ilinde, premium filo ve 7/24 destek ile yolculuğun keyfini çıkarın.</p>
        <div class="search-glass-panel">
            <form action="{{ url_for('index') }}" method="GET">
                <div class="row g-3 align-items-end">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label-glass"><i class="fas fa-map-marker-alt me-1"></i> Alış Yeri</label>
                        <select class="form-select form-control-glass" name="sehir_id" id="sehirSelect" onchange="haritayiGuncelle(this.value)">
                            <option value="">Tüm Şehirler</option>
                            {% for sehir in sehirler %}
                                <option value="{{ sehir.sehir_id }}" {% if secilen_sehir_id|string == sehir.sehir_id|string %}selected{% endif %}>{{ sehir.sehir_ad }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label-glass"><i class="fas fa-calendar-alt me-1"></i> Alış Tarihi</label>
                        <input type="date" name="baslangic" id="baslangic" class="form-control form-control-glass" value="{{ request.args.get('baslangic') }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label-glass"><i class="fas fa-calendar-check me-1"></i> Dönüş Tarihi</label>
                        <input type="date" name="bitis" id="bitis" class="form-control form-control-glass" value="{{ request.args.get('bitis') }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button type="submit" class="btn btn-warning w-100 fw-bold shadow" style="height: 50px; font-size: 1.1rem;">ARAÇ BUL <i class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container-fluid px-5">
    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm sticky-top hover-card" style="top: 100px; z-index: 900;">
                <div class="card-header bg-dark text-warning fw-bold py-3"><i class="fas fa-filter me-2"></i>Detaylı Filtrele</div>
                <div class="card-body bg-light">
                    <form action="{{ url_for('index') }}" method="GET" id="filterForm">
                        <input type="hidden" name="sehir_id" value="{{ request.args.get('sehir_id', '') }}">
                        <input type="hidden" name="baslangic" value="{{ request.args.get('baslangic', '') }}">
                        <input type="hidden" name="bitis" value="{{ request.args.get('bitis', '') }}">

                        <div class="mb-3">
                            <label class="form-label fw-bold">Vites Tipi</label>
                            <select name="vites" class="form-select">
                                <option value="">Tümü</option>
                                <option value="Otomatik" {% if request.args.get('vites') == 'Otomatik' %}selected{% endif %}>Otomatik</option>
                                <option value="Manuel" {% if request.args.get('vites') == 'Manuel' %}selected{% endif %}>Manuel</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Yakıt Tipi</label>
                            <select name="yakit" class="form-select">
                                <option value="">Tümü</option>
                                <option value="Benzin" {% if request.args.get('yakit') == 'Benzin' %}selected{% endif %}>Benzin</option>
                                <option value="Dizel" {% if request.args.get('yakit') == 'Dizel' %}selected{% endif %}>Dizel</option>
                                <option value="Elektrik" {% if request.args.get('yakit') == 'Elektrik' %}selected{% endif %}>Elektrik</option>
                                <option value="Hibrit" {% if request.args.get('yakit') == 'Hibrit' %}selected{% endif %}>Hibrit</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Günlük Fiyat Aralığı</label>
                            <div class="d-flex gap-2">
                                <input type="number" name="min_fiyat" class="form-control" placeholder="Min" value="{{ request.args.get('min_fiyat') }}" min="0">
                                <input type="number" name="max_fiyat" class="form-control" placeholder="Max" value="{{ request.args.get('max_fiyat') }}" min="0">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-dark w-100 fw-bold">Filtreleri Uygula</button>
                        <a href="{{ url_for('index') }}" class="btn btn-link w-100 text-muted mt-2 text-decoration-none small">Temizle</a>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div id="map" class="hover-card"></div>

            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="fw-bold mb-0"><i class="fas fa-car me-2 text-dark"></i>Premium Filo</h3>
                <span class="badge bg-dark p-2">{{ araclar|length }} Müsait Araç</span>
            </div>

            <div class="row mb-5">
                {% if araclar %}
                    {% for arac in araclar %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm border-0 position-relative hover-card">
                            <div class="position-relative">
                                <button onclick="toggleFavori({{ arac.arac_id }}, this)" 
                                        class="btn btn-heart position-absolute top-0 end-0 m-3 rounded-circle shadow d-flex align-items-center justify-content-center"
                                        style="width: 40px; height: 40px; background: rgba(0,0,0,0.6); border: none; z-index: 10;">
                                    <i class="{{ 'fas text-warning' if fav_ids and arac.arac_id in fav_ids else 'far text-white' }} fa-heart fs-5"></i>
                                </button>

                                <span class="badge bg-dark position-absolute top-0 start-0 m-3 shadow">{{ arac.yakit_turu }}</span>
                                <img src="{{ url_for('static', filename='img/' + arac.resim_url) }}" class="card-img-top" alt="{{ arac.marka }}" style="height: 220px; object-fit: cover;">
                            </div>
                            <div class="card-body">
                                <h5 class="card-title fw-bold text-center mb-1">{{ arac.marka }} {{ arac.model }}</h5>
                                <div class="text-center text-muted small mb-3">
                                    <i class="fas fa-map-marker-alt text-warning me-1"></i>{{ arac.sehir_ad }} &bull; {{ arac.yil }}
                                </div>
                                <div class="d-flex justify-content-between align-items-center border-top pt-3 mt-2">
                                    <div>
                                        <span class="h4 fw-bold text-dark">{{ arac.gunluk_ucret }} ₺</span>
                                        <small class="text-muted">/gün</small>
                                    </div>
                                    <a href="{{ url_for('rezervasyon', arac_id=arac.arac_id, baslangic=request.args.get('baslangic'), bitis=request.args.get('bitis')) }}" 
                                       class="btn btn-warning fw-bold px-4 rounded-pill shadow-sm">
                                        Kirala
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <div class="alert alert-light text-center border shadow-sm py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5>Aradığınız kriterlere uygun araç bulunamadı.</h5>
                            <p class="text-muted">Lütfen sol taraftan filtreleri değiştirerek tekrar deneyin.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mb-5 bg-light p-5 rounded-3 container hover-card" id="yorumlarBolumu">
    <div class="text-center mb-5">
        <h2 class="fw-bold">Mutlu Müşteriler</h2>
        <p class="text-muted">Sizden gelen gerçek geri bildirimler.</p>
        {% if session.get('role') == 'musteri' %}
            <button class="btn btn-dark fw-bold px-4 rounded-pill" data-bs-toggle="modal" data-bs-target="#yorumModal">
                <i class="fas fa-pen me-2"></i>Yorum Yaz
            </button>
        {% endif %}
    </div>
    <div class="row">
        {% for yorum in yorumlar %}
        <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100 hover-card">
                <div class="card-body p-4">
                    <div class="text-warning mb-3">{% for i in range(yorum.puan) %}<i class="fas fa-star"></i>{% endfor %}</div>
                    <p class="fst-italic text-secondary">"{{ yorum.yorum_metni }}"</p>
                    <div class="d-flex align-items-center mt-4">
                        <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow" style="width: 45px; height: 45px;">
                            {{ yorum.ad[0] }}{{ yorum.soyad_bas_harf }}
                        </div>
                        <div class="ms-3">
                            <h6 class="mb-0 fw-bold">{{ yorum.ad }} {{ yorum.soyad_bas_harf }}.</h6>
                            <small class="text-muted" style="font-size: 12px;">{{ yorum.sehir_ad or 'Müşteri' }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
            <p class="text-center text-muted">Henüz onaylanmış yorum yok.</p>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="yorumModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title fw-bold text-dark">Deneyiminizi Paylaşın</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{{ url_for('yorum_yap') }}" method="POST">
          <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Puanınız</label>
                <select name="puan" class="form-select">
                    <option value="5">⭐⭐⭐⭐⭐ - Mükemmel</option>
                    <option value="4">⭐⭐⭐⭐ - Çok İyi</option>
                    <option value="3">⭐⭐⭐ - Orta</option>
                    <option value="2">⭐⭐ - Kötü</option>
                    <option value="1">⭐ - Çok Kötü</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Yorumunuz</label>
                <textarea name="yorum_metni" class="form-control" rows="3" placeholder="Yorumunuzu buraya yazın..." required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-dark w-100 fw-bold">Gönder</button>
          </div>
      </form>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var today = new Date().toISOString().split('T')[0];
        var baslangicInput = document.getElementById("baslangic");
        var bitisInput = document.getElementById("bitis");

        if(baslangicInput && bitisInput) {
            baslangicInput.setAttribute('min', today);
            bitisInput.setAttribute('min', today);

            baslangicInput.addEventListener("change", function() {
                var selectedDate = this.value;
                bitisInput.setAttribute('min', selectedDate);
                if(bitisInput.value && bitisInput.value < selectedDate) {
                    bitisInput.value = selectedDate;
                }
            });
        }
    });

    function toggleFavori(aracId, btn) {
        fetch(`/toggle-favori/${aracId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(r => { if(r.status===401) window.location.href="/login"; return r.json() })
        .then(d => {
            if(d.status==='success') {
                const i = btn.querySelector('i');
                if (d.action === 'added') {
                    i.classList.remove('far', 'text-white'); i.classList.add('fas', 'text-warning');
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: 'Favorilere eklendi' });
                } else {
                    i.classList.remove('fas', 'text-warning'); i.classList.add('far', 'text-white');
                }
            }
        });
    }

    // --- [GÜNCELLENDİ] HARİTA VE 20 ŞEHİR KOORDİNATI ---
    var map = L.map('map', {zoomControl: false}).setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

    // seed.py'deki 20 şehrin koordinatları (ID'ye göre)
    var sehirKoordinatlari = {
        1: [41.0082, 28.9784], // İstanbul
        2: [39.9334, 32.8597], // Ankara
        3: [38.4192, 27.1287], // İzmir
        4: [37.8746, 32.4931], // Konya
        5: [36.8969, 30.7133], // Antalya
        6: [40.1885, 29.0610], // Bursa
        7: [37.0000, 35.3213], // Adana
        8: [37.0662, 37.3833], // Gaziantep
        9: [38.7312, 35.4787], // Kayseri
        10: [39.7667, 30.5256], // Eskişehir
        11: [36.8121, 34.6415], // Mersin
        12: [41.2867, 36.33],   // Samsun
        13: [41.0027, 39.7168], // Trabzon
        14: [37.7765, 29.0864], // Denizli
        15: [37.9144, 40.2306], // Diyarbakır
        16: [37.1591, 38.7969], // Şanlıurfa
        17: [38.3552, 38.3095], // Malatya
        18: [37.8560, 27.8416], // Aydın
        19: [37.2153, 28.3636], // Muğla
        20: [40.9833, 27.5167]  // Tekirdağ
    };

    var currentMarker = null;

    function haritayiGuncelle(id) {
        if(id && sehirKoordinatlari[id]) {
            var c = sehirKoordinatlari[id];
            map.flyTo(c, 11, {duration: 2});
            if(currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker(c).addTo(map).bindPopup("<b>Teslimat Noktası</b><br>Şubemiz burada hizmetinizde.").openPopup();
        } else {
            map.setView([39.0, 35.0], 6);
            if(currentMarker) map.removeLayer(currentMarker);
        }
    }
    
    // Sayfa yüklendiğinde seçili şehir varsa oraya git
    var secilenID = "{{ secilen_sehir_id }}";
    if(secilenID) haritayiGuncelle(secilenID);
</script>

{% endblock %}