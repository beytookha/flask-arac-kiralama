{% extends "layout.html" %}

{% block content %}
<div class="container py-5 mt-5">
    <div class="row g-5">
        
        <div class="col-lg-5 order-lg-2">
            <div class="card bg-dark text-white border-warning shadow-lg">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="fas fa-receipt me-2"></i>Sipariş Özeti
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <img src="{{ url_for('static', filename='img/' + arac.resim_url) }}" class="rounded me-3 border border-secondary" width="80" alt="Arac">
                        <div>
                            <h5 class="mb-0 text-warning">{{ arac.marka }} {{ arac.model }}</h5>
                            <small class="text-secondary">{{ session['rezervasyon_bilgi']['gun_sayisi'] }} Günlük Kiralama</small>
                        </div>
                    </div>
                    <hr class="border-secondary">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Araç ve Hizmetler Toplamı:</span>
                        <span class="fs-5" id="hamFiyat">{{ session['rezervasyon_bilgi']['toplam_ucret'] }} TL</span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3 text-success d-none" id="indirimSatiri">
                        <span><i class="fas fa-tag me-1"></i> İndirim (<span id="indirimOranText">%0</span>):</span>
                        <span class="fw-bold">-<span id="indirimMiktar">0</span> TL</span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center pt-2 border-top border-secondary">
                        <span class="fs-4 fw-bold">ÖDENECEK TUTAR:</span>
                        <span class="fs-2 fw-bold text-warning" id="displayTutar">{{ session['rezervasyon_bilgi']['toplam_ucret'] }} TL</span>
                    </div>
                </div>
                
                <div class="card-footer bg-secondary bg-opacity-25 border-top border-secondary p-3">
                    <label class="small text-warning fw-bold mb-2"><i class="fas fa-gift me-1"></i> İndirim Kodunuz var mı?</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-white border-secondary" id="kuponKodu" placeholder="Örn: YAZ2025" style="text-transform: uppercase;">
                        <button class="btn btn-warning fw-bold" type="button" onclick="kuponUygula()">Uygula</button>
                    </div>
                    <small id="kuponMesaj" class="mt-2 d-block fw-bold"></small>
                </div>
            </div>
        </div>

        <div class="col-lg-7 order-lg-1">
            <h3 class="fw-bold mb-4 text-dark"><i class="fas fa-shield-alt text-success me-2"></i>Güvenli Ödeme</h3>
            
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form action="{{ url_for('odeme_yap') }}" method="POST">
                        
                        <input type="hidden" name="final_tutar" id="inputFinalTutar" value="{{ session['rezervasyon_bilgi']['toplam_ucret'] }}">
                        <input type="hidden" name="uygulanan_kod" id="inputKod" value="">

                        <div class="mb-4">
                            <label class="form-label fw-bold text-muted">Kart Üzerindeki İsim</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="fas fa-user text-secondary"></i></span>
                                <input type="text" class="form-control" name="kart_sahibi" id="kartSahibi" placeholder="Ad Soyad" required>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-muted">Kart Numarası</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light"><i class="far fa-credit-card text-secondary"></i></span>
                                <input type="text" class="form-control" name="kart_no" id="kartNo" placeholder="0000 0000 0000 0000" maxlength="19" required>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted">Son Kullanma Tarihi</label>
                                <div class="input-group">
                                    <select class="form-select" name="sk_ay" required>
                                        <option value="" selected disabled>Ay</option>
                                        {% for i in range(1, 13) %}
                                            <option value="{{ '%02d' % i }}">{{ '%02d' % i }}</option>
                                        {% endfor %}
                                    </select>
                                    <select class="form-select" name="sk_yil" required>
                                        <option value="" selected disabled>Yıl</option>
                                        {% for i in range(2025, 2036) %}
                                            <option value="{{ i }}">{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted">CVV</label>
                                <input type="text" class="form-control" placeholder="***" maxlength="3" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold text-muted">Ödeme Yöntemi</label>
                            <select class="form-select" name="odeme_turu">
                                <option value="Kredi Kartı">Kredi Kartı / Banka Kartı</option>
                                <option value="Havale">Havale / EFT</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-dark w-100 py-3 fs-5 fw-bold shadow-lg">
                            <i class="fas fa-lock me-2"></i> <span id="btnTutar">{{ session['rezervasyon_bilgi']['toplam_ucret'] }} TL</span> ÖDE
                        </button>
                        
                        <div class="text-center mt-4 text-muted">
                            <small class="d-block mb-2"><i class="fas fa-lock text-success"></i> 256-Bit SSL ile güvenli ödeme</small>
                            <div class="fs-2">
                                <i class="fab fa-cc-visa text-primary mx-1"></i>
                                <i class="fab fa-cc-mastercard text-danger mx-1"></i>
                                <i class="fab fa-cc-amex text-info mx-1"></i>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let orjinalTutar = parseFloat("{{ session['rezervasyon_bilgi']['toplam_ucret'] }}");
    let uygulananIndirim = false;

    // 1. Kart Sahibi (Sadece Harf)
    document.getElementById('kartSahibi').addEventListener('input', function (e) {
        this.value = this.value.replace(/[^a-zA-ZğüşıöçĞÜŞİÖÇ\s]/g, '');
    });

    // 2. Kart Numarası (4-4-4-4 Formatı)
    document.getElementById('kartNo').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '').substring(0, 16);
        let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formatted;
    });

    function kuponUygula() {
        const kodInput = document.getElementById('kuponKodu');
        const kod = kodInput.value.toUpperCase().trim();
        const mesajKutusu = document.getElementById('kuponMesaj');

        if (!kod) {
            mesajKutusu.innerHTML = '<span class="text-danger">Lütfen bir kod giriniz.</span>';
            return;
        }
        
        if (uygulananIndirim) {
            Swal.fire("Uyarı", "Zaten bir indirim uyguladınız!", "warning");
            return;
        }

        fetch('/check-coupon', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({kod: kod})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let indirimMiktari = orjinalTutar * (data.oran / 100);
                let yeniTutar = orjinalTutar - indirimMiktari;

                document.getElementById('indirimSatiri').classList.remove('d-none');
                document.getElementById('indirimOranText').innerText = "%" + data.oran;
                document.getElementById('indirimMiktar').innerText = indirimMiktari.toFixed(2);
                
                document.getElementById('displayTutar').innerText = yeniTutar.toFixed(2) + " TL";
                document.getElementById('btnTutar').innerText = yeniTutar.toFixed(2) + " TL";
                
                document.getElementById('inputFinalTutar').value = yeniTutar.toFixed(2);
                document.getElementById('inputKod').value = kod;

                mesajKutusu.innerHTML = `<span class="text-success"><i class="fas fa-check-circle"></i> ${data.mesaj}</span>`;
                kodInput.disabled = true;
                uygulananIndirim = true;

                Swal.fire({
                    icon: 'success',
                    title: 'Süper!',
                    text: `${data.oran}% indirim uygulandı.`,
                    confirmButtonColor: '#ffc107',
                    timer: 2000
                });
            } else {
                mesajKutusu.innerHTML = `<span class="text-danger"><i class="fas fa-times-circle"></i> ${data.mesaj}</span>`;
                kodInput.classList.add('is-invalid');
                setTimeout(() => kodInput.classList.remove('is-invalid'), 2000);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            mesajKutusu.innerHTML = '<span class="text-danger">Bağlantı hatası oluştu.</span>';
        });
    }
</script>
{% endblock %}