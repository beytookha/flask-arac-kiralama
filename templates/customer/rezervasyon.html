{% extends "layout.html" %}

{% block content %}
<div class="container py-5 mt-4">

    <div class="text-center mb-5">
        <h2 class="fw-bold text-uppercase text-dark" style="letter-spacing: 2px;">
            <i class="fas fa-calendar-check text-warning me-2"></i>REZERVASYONUNU TAMAMLA
        </h2>
        <p class="text-muted">Seçtiğiniz aracı kiralamak için tarihleri girin ve ekstra hizmetleri ekleyin.</p>
    </div>

    <form action="{{ url_for('rezervasyon', arac_id=arac.arac_id) }}" method="POST" id="rezervasyonForm">
        <div class="row g-4">

            <div class="col-lg-4">
                <div class="card bg-dark text-white border-warning shadow-lg sticky-top"
                    style="top: 100px; z-index: 1;">
                    <div class="position-relative">
                        <img src="{{ url_for('static', filename='img/' + arac.resim_url) }}"
                            class="card-img-top p-2 rounded-4" alt="Araç Resmi" style="opacity: 0.9;">
                        <span class="position-absolute top-0 end-0 m-3 badge bg-warning text-dark fw-bold fs-6">
                            {{ arac.gunluk_ucret }} TL / Gün
                        </span>
                    </div>

                    <div class="card-body">
                        <h3 class="card-title text-warning fw-bold text-center mb-3">{{ arac.marka }} {{ arac.model }}
                        </h3>

                        <div class="row g-2 text-center text-secondary small mb-3">
                            <div
                                class="col-6 bg-secondary bg-opacity-10 py-2 rounded border border-secondary border-opacity-25">
                                <i class="fas fa-gas-pump text-warning mb-1 d-block fs-5"></i> {{ arac.yakit_turu }}
                            </div>
                            <div
                                class="col-6 bg-secondary bg-opacity-10 py-2 rounded border border-secondary border-opacity-25">
                                <i class="fas fa-cogs text-warning mb-1 d-block fs-5"></i> {{ arac.vites_turu }}
                            </div>
                            <div
                                class="col-6 bg-secondary bg-opacity-10 py-2 rounded border border-secondary border-opacity-25">
                                <i class="fas fa-calendar text-warning mb-1 d-block fs-5"></i> {{ arac.yil }}
                            </div>
                            <div
                                class="col-6 bg-secondary bg-opacity-10 py-2 rounded border border-secondary border-opacity-25">
                                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}"
                                        class="text-warning text-decoration-none">Ana Sayfa</a></li> {{ arac.kilometre
                                }} km
                            </div>
                        </div>

                        <hr class="border-secondary">

                        <div class="bg-secondary bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-light">Gün Sayısı:</span>
                                <span class="fw-bold text-white" id="ozetGun">0 Gün</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-light">Araç Bedeli:</span>
                                <span class="fw-bold text-white" id="ozetArac">0 TL</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-light">Ekstralar:</span>
                                <span class="fw-bold text-warning" id="ozetEkstra">0 TL</span>
                            </div>
                            <div
                                class="border-top border-secondary pt-2 d-flex justify-content-between align-items-center">
                                <span class="fs-5 text-white fw-bold">TOPLAM:</span>
                                <span class="fs-4 fw-bold text-warning" id="toplamUcret">0 TL</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-warning w-100 fw-bold mt-3 py-3 fs-5 shadow-sm btn-glow">
                            ÖDEMEYE GEÇ <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-dark text-warning fw-bold py-3">
                        <i class="fas fa-clock me-2"></i>1. Kiralama Süresi
                    </div>
                    <div class="card-body bg-light">
                        <div class="row g-3">

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">ALIŞ TARİHİ</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="fas fa-calendar-alt text-warning"></i></span>
                                    <input type="date" class="form-control border-start-0 ps-0" name="baslangic_tarihi"
                                        id="baslangic" value="{{ url_baslangic if url_baslangic else '' }}" required
                                        onchange="hesapla()">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">ALIŞ SAATİ</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="fas fa-clock text-warning"></i></span>
                                    <select name="alis_saati" class="form-select border-start-0 ps-0" required>
                                        <option value="09:00">09:00</option>
                                        <option value="10:00">10:00</option>
                                        <option value="11:00">11:00</option>
                                        <option value="12:00">12:00</option>
                                        <option value="13:00">13:00</option>
                                        <option value="14:00">14:00</option>
                                        <option value="15:00">15:00</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">İADE TARİHİ</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="fas fa-calendar-check text-warning"></i></span>
                                    <input type="date" class="form-control border-start-0 ps-0" name="bitis_tarihi"
                                        id="bitis" value="{{ url_bitis if url_bitis else '' }}" required
                                        onchange="hesapla()">
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted">İADE SAATİ</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="fas fa-history text-warning"></i></span>
                                    <select name="teslim_saati" class="form-select border-start-0 ps-0" required>
                                        <option value="09:00">09:00</option>
                                        <option value="10:00">10:00</option>
                                        <option value="11:00">11:00</option>
                                        <option value="12:00">12:00</option>
                                        <option value="13:00">13:00</option>
                                        <option value="14:00">14:00</option>
                                        <option value="15:00">15:00</option>
                                    </select>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-dark text-warning fw-bold py-3">
                        <i class="fas fa-plus-circle me-2"></i>2. Ekstra Hizmetler (İsteğe Bağlı)
                    </div>
                    <div class="card-body bg-light">
                        <p class="small text-muted mb-3">Seyahatinizi daha konforlu hale getirmek için aşağıdaki
                            paketlerden ekleyebilirsiniz.</p>

                        <div class="row g-3">
                            {% for ekstra in ekstralar %}
                            <div class="col-md-6">
                                <label class="custom-option d-block position-relative cursor-pointer h-100">
                                    <input type="checkbox" name="ekstra" value="{{ ekstra.ekstra_id }}"
                                        data-fiyat="{{ ekstra.gunluk_ucret }}"
                                        class="ekstra-checkbox position-absolute opacity-0" onchange="hesapla()">

                                    <div
                                        class="option-card border rounded p-3 bg-white h-100 d-flex align-items-center transition-all">
                                        <div class="icon-box bg-dark text-warning rounded-circle d-flex align-items-center justify-content-center me-3"
                                            style="width: 50px; height: 50px; flex-shrink: 0;">
                                            <i class="{{ ekstra.ikon }} fs-4"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="fw-bold mb-1 text-dark">{{ ekstra.ad }}</h6>
                                            <span class="badge bg-warning text-dark">+{{ ekstra.gunluk_ucret }} TL /
                                                Gün</span>
                                        </div>
                                        <div class="check-icon text-success fs-3 d-none">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            {% else %}
                            <div class="col-12 text-center text-muted">
                                <i class="fas fa-exclamation-circle"></i> Ekstra hizmet bulunamadı. (Lütfen db_reset.py
                                çalıştırın)
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>

                <div class="alert alert-warning mt-4 d-flex align-items-center" role="alert">
                    <i class="fas fa-info-circle fs-4 me-3"></i>
                    <div>
                        <strong>Bilgilendirme:</strong> Ödeme sayfasına geçtiğinizde aracınız sizin adınıza rezerve
                        edilecektir.
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<style>
    /* Özel Seçim Kartı Stili */
    .option-card {
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    /* Seçili Olduğunda */
    .ekstra-checkbox:checked+.option-card {
        border-color: #ffc107;
        background-color: #fffbf0;
        /* Çok açık sarı zemin */
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2);
    }

    .ekstra-checkbox:checked+.option-card .check-icon {
        display: block !important;
    }

    .cursor-pointer {
        cursor: pointer;
    }

    /* Buton Parlama Efekti */
    .btn-glow:hover {
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
        transform: translateY(-2px);
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Bugünün tarihini minimum olarak ayarla (Geçmişe rezervasyon yapılamaz)
        const today = new Date().toISOString().split('T')[0];
        const baslangicInput = document.getElementById('baslangic');
        const bitisInput = document.getElementById('bitis');

        if (baslangicInput && bitisInput) {
            baslangicInput.setAttribute('min', today);
            bitisInput.setAttribute('min', today);

            // Eğer değer varsa hesapla (Index'ten gelmişse)
            if (baslangicInput.value && bitisInput.value) {
                hesapla();
            }
        }
    });

    function formatMoney(amount) {
        return amount.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + " TL";
    }

    function hesapla() {
        const gunlukUcret = {{ arac.gunluk_ucret }
    };
    const baslangic = document.getElementById('baslangic').value;
    const bitis = document.getElementById('bitis').value;

    let gunSayisi = 0;
    let aracToplam = 0;
    let ekstraToplam = 0;
    let genelToplam = 0;

    if (baslangic && bitis) {
        const d1 = new Date(baslangic);
        const d2 = new Date(bitis);
        const fark = d2 - d1;
        gunSayisi = Math.ceil(fark / (1000 * 60 * 60 * 24));
    }

    if (gunSayisi > 0) {
        aracToplam = gunSayisi * gunlukUcret;

        // Ekstraları Topla
        const checkboxlar = document.querySelectorAll('.ekstra-checkbox');
        checkboxlar.forEach(cb => {
            if (cb.checked) {
                const fiyat = parseFloat(cb.getAttribute('data-fiyat'));
                ekstraToplam += (fiyat * gunSayisi);
            }
        });

        genelToplam = aracToplam + ekstraToplam;
    } else {
        gunSayisi = 0; // Negatif veya geçersiz tarih
    }

    // Değerleri Ekrana Yaz
    document.getElementById('ozetGun').innerText = gunSayisi + " Gün";
    document.getElementById('ozetArac').innerText = formatMoney(aracToplam);
    document.getElementById('ozetEkstra').innerText = formatMoney(ekstraToplam);
    document.getElementById('toplamUcret').innerText = formatMoney(genelToplam);
    }
</script>
{% endblock %}